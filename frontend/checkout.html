<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VitalBites - Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Animation for checkout sections */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .checkout-card {
            animation: fadeIn 0.5s ease-out forwards;
            animation-delay: calc(var(--order) * 0.1s);
        }

        /* Enable dark mode for the entire page */
        body,
        .bg-gray-50,
        .bg-white {
            background-color: #18181b !important;
            color: #f3f4f6 !important;
        }

        .text-gray-800,
        .text-gray-700,
        .text-gray-600,
        .text-gray-500,
        .text-gray-400,
        .text-gray-900 {
            color: #f3f4f6 !important;
        }

        .bg-white,
        .bg-gray-100,
        .bg-orange-100,
        .bg-gray-50,
        .bg-orange-50 {
            background-color: #23232a !important;
        }

        .border-gray-200,
        .border-gray-100,
        .border-orange-200,
        .border-gray-300,
        .border-gray-700 {
            border-color: #2d2d36 !important;
        }

        .shadow-md,
        .shadow-lg,
        .shadow-xl {
            box-shadow: 0 4px 24px 0 rgba(0, 0, 0, 0.7) !important;
        }

        .rounded-full,
        .rounded-lg,
        .rounded-xl {
            background-clip: padding-box;
        }

        .hover\:bg-gray-100:hover,
        .hover\:bg-gray-300:hover,
        .hover\:bg-gray-900:hover,
        .hover\:bg-gray-50:hover {
            background-color: #2d2d36 !important;
        }

        .bg-orange-500,
        .hover\:bg-orange-500:hover,
        .hover\:bg-orange-600:hover,
        .bg-orange-600 {
            background-color: #ff8800 !important;
        }

        .text-orange-500 {
            color: #ff8800 !important;
        }

        .bg-gray-200 {
            background-color: #23232a !important;
        }

        .bg-gray-800 {
            background-color: #18181b !important;
        }

        .bg-black {
            background-color: #101014 !important;
        }

        .text-white {
            color: #f3f4f6 !important;
        }

        .text-red-500 {
            color: #ff4d4f !important;
        }

        .bg-gray-900,
        .hover\:bg-gray-800:hover {
            background-color: #101014 !important;
        }

        input,
        textarea,
        select {
            background-color: #23232a !important;
            color: #f3f4f6 !important;
            border-color: #2d2d36 !important;
        }

        /* Scrollbar dark */
        ::-webkit-scrollbar {
            background: #23232a;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* Progress steps */
        .step {
            transition: all 0.3s ease;
        }

        .step.active {
            background-color: #ff8800;
            color: white;
        }

        .step.completed {
            background-color: #22c55e;
            color: white;
        }

        #map {
            width: 100%;
            height: 320px;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid #2d2d36;
        }

        .leaflet-popup-content {
            background: #23232a !important;
            color: #f3f4f6 !important;
        }
    </style>
</head>

<body class="bg-gray-50 font-sans min-h-screen">
    <!-- Header -->
    <header class="bg-gray-900 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Brand Logo -->
                <div class="flex items-center space-x-2 cursor-pointer" onclick="window.location.href='index.html'">
                    <div>
                        <h1
                            class="text-2xl font-bold bg-gradient-to-r from-orange-400 to-red-500 bg-clip-text text-transparent">
                            VitalBites
                        </h1>
                        <p class="text-xs text-gray-400 hidden sm:block">Fresh • Fast • Delicious</p>
                    </div>
                </div>

                <!-- Center - Progress Steps (hidden on mobile) -->
                <div class="hidden md:flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div
                            class="step active w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">
                            1
                        </div>
                        <span class="text-gray-300 text-sm">Checkout</span>
                    </div>
                    <div class="w-8 h-0.5 bg-gray-600"></div>
                    <div class="flex items-center space-x-2">
                        <div
                            class="step w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-sm font-bold text-gray-400">
                            2
                        </div>
                        <span class="text-gray-400 text-sm">Payment</span>
                    </div>
                    <div class="w-8 h-0.5 bg-gray-600"></div>
                    <div class="flex items-center space-x-2">
                        <div
                            class="step w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-sm font-bold text-gray-400">
                            3
                        </div>
                        <span class="text-gray-400 text-sm">Complete</span>
                    </div>
                </div>

                <!-- Right Navigation -->
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <!-- Back to Menu -->
                    <button onclick="window.location.href='index.html'"
                        class="flex items-center space-x-2 text-gray-300 hover:text-white transition-all duration-300 p-3 rounded-lg hover:bg-gray-700 bg-gray-800 group">
                        <i class="fas fa-arrow-left text-lg group-hover:scale-110 transition-transform"></i>
                        <span class="hidden sm:block font-medium">Back to Menu</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column - Order Details & Forms -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Cart Items -->
                <section class="bg-white rounded-xl shadow-lg p-6 checkout-card" style="--order: 0">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-shopping-basket text-orange-500 mr-3"></i>
                            Your Order
                        </h2>
                        <div class="text-right">
                            <span id="cart-count-display" class="text-sm text-gray-600">0 items</span>
                            <button onclick="window.location.href='index.html'"
                                class="ml-4 text-orange-500 hover:text-orange-600 text-sm font-medium transition-colors">
                                <i class="fas fa-plus mr-1"></i>Add More Items
                            </button>
                        </div>
                    </div>
                    <div id="cart-items" class="mb-4"></div>
                </section>

                <!-- Delivery Address -->
                <section class="bg-white rounded-xl shadow-lg p-6 checkout-card" style="--order: 1">
                    <h3 class="text-xl font-bold mb-6 text-gray-800 flex items-center">
                        <i class="fas fa-map-marker-alt text-orange-500 mr-3"></i>
                        Delivery Address
                    </h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Saved Addresses</label>
                        <select id="saved-addresses"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 mb-2">
                            <option value="">Select a saved address</option>
                        </select>
                        <button type="button" id="use-address-btn"
                            class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-all duration-300 font-medium">
                            <i class="fas fa-check mr-2"></i>Use This Address
                        </button>
                        <button type="button" id="delete-address-btn"
                            class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-all duration-300 font-medium ml-2">
                            <i class="fas fa-trash mr-2"></i>Delete Selected Address
                        </button>
                    </div>
                    <div class="mb-6">
                        <button type="button" id="use-location-btn"
                            class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-all duration-300 font-medium mb-2">
                            <i class="fas fa-location-arrow mr-2"></i>Use My Location
                        </button>
                        <div id="map"></div>
                        <div id="location-message" class="text-sm text-orange-500 mb-2"></div>
                    </div>
                    <form id="address-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                <input type="text" id="fullName"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-300"
                                    placeholder="Enter your full name" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mobile Number</label>
                                <input type="tel" id="mobile"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-300"
                                    placeholder="Enter 10-digit mobile number" maxlength="10" pattern="[6-9][0-9]{9}"
                                    required>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Street Address</label>
                            <textarea id="street" rows="3"
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-300"
                                placeholder="Enter your complete street address" required></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                                <input type="text" id="city"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-300"
                                    placeholder="City" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                                <input type="text" id="state"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-300"
                                    placeholder="State" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pincode</label>
                                <input type="text" id="pincode"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-300"
                                    placeholder="Pincode" maxlength="6" pattern="[0-9]{6}" required>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Instructions</label>
                            <textarea id="deliveryInstructions" rows="2"
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-300"
                                placeholder="E.g. Leave at the door, call on arrival"></textarea>
                        </div>
                        <button type="button" id="save-address-btn"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all duration-300 font-medium mt-2">
                            <i class="fas fa-save mr-2"></i>Save Address
                        </button>
                    </form>
                </section>

                <!-- Payment Options -->
                <section class="bg-white rounded-xl shadow-lg p-6 checkout-card" style="--order: 2">
                    <h3 class="text-xl font-bold mb-6 text-gray-800 flex items-center">
                        <i class="fas fa-credit-card text-orange-500 mr-3"></i>
                        Payment Method
                    </h3>
                    <div class="space-y-4">
                        <label
                            class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-all duration-300">
                            <input type="radio" name="payment" value="cod" class="mr-4 text-orange-500" checked>
                            <div class="flex items-center">
                                <i class="fas fa-money-bill-wave text-green-500 text-xl mr-3"></i>
                                <div>
                                    <div class="font-medium text-gray-800">Cash on Delivery</div>
                                    <div class="text-sm text-gray-600">Pay when your order arrives</div>
                                </div>
                            </div>
                        </label>

                        <label
                            class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-all duration-300">
                            <input type="radio" name="payment" value="upi" class="mr-4 text-orange-500">
                            <div class="flex items-center">
                                <i class="fas fa-mobile-alt text-blue-500 text-xl mr-3"></i>
                                <div>
                                    <div class="font-medium text-gray-800">UPI Payment</div>
                                    <div class="text-sm text-gray-600">Pay using UPI apps</div>
                                </div>
                            </div>
                        </label>

                        <label
                            class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-all duration-300">
                            <input type="radio" name="payment" value="card" class="mr-4 text-orange-500">
                            <div class="flex items-center">
                                <i class="fas fa-credit-card text-purple-500 text-xl mr-3"></i>
                                <div>
                                    <div class="font-medium text-gray-800">Credit/Debit Card</div>
                                    <div class="text-sm text-gray-600">Pay securely with your card</div>
                                </div>
                            </div>
                        </label>
                    </div>
                </section>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="lg:col-span-1">
                <div class="sticky top-24">
                    <!-- Order Summary -->
                    <section class="bg-white rounded-xl shadow-lg p-6 checkout-card" style="--order: 3">
                        <h3 class="text-xl font-bold mb-6 text-gray-800 flex items-center">
                            <i class="fas fa-file-invoice-dollar text-orange-500 mr-3"></i>
                            Order Summary
                        </h3>

                        <div class="space-y-4 mb-6">
                            <!-- Coupon Section -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Have a coupon?</label>
                                <div class="flex gap-2">
                                    <input type="text" id="coupon-code"
                                        class="flex-1 px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-300"
                                        placeholder="Enter coupon code">
                                    <button type="button" id="apply-coupon"
                                        class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-all duration-300 font-medium">
                                        Apply
                                    </button>
                                </div>
                                <div id="coupon-message" class="mt-2 text-sm"></div>
                            </div>
                        </div>

                        <!-- Bill Details -->
                        <div class="space-y-3 border-t border-gray-200 pt-4">
                            <div class="flex justify-between items-center text-gray-700">
                                <span>Subtotal</span>
                                <span id="subtotal">₹0.00</span>
                            </div>
                            <div class="flex justify-between items-center text-gray-700">
                                <span>Delivery Fee</span>
                                <span id="delivery-fee">₹40.00</span>
                            </div>
                            <div class="flex justify-between items-center text-gray-700">
                                <span>Taxes & Fees</span>
                                <span id="taxes">₹0.00</span>
                            </div>
                            <div id="discount-row" class="hidden flex justify-between items-center text-green-600">
                                <span>Discount</span>
                                <span id="discount">-₹0.00</span>
                            </div>
                            <hr class="border-gray-200">
                            <div class="flex justify-between items-center text-lg font-bold text-gray-900">
                                <span>Total Amount</span>
                                <span id="total-amount">₹0.00</span>
                            </div>
                        </div>

                        <!-- Place Order Button -->
                        <button id="place-order"
                            class="w-full mt-6 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white py-4 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg">
                            <i class="fas fa-check-circle mr-2"></i>
                            Place Order
                        </button>

                        <!-- Estimated Delivery -->
                        <div class="mt-4 p-3 bg-orange-50 rounded-lg text-center">
                            <i class="fas fa-clock text-orange-500 mr-2"></i>
                            <span class="text-sm text-gray-700">Estimated delivery: 25-35 minutes</span>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 py-6 mt-12">
        <div class="container mx-auto px-6 text-center text-gray-400 text-sm">
            <p>© 2025 VitalBites. All rights reserved.</p>
        </div>
    </footer>

    <!-- Add this in <head> (replace YOUR_GOOGLE_MAPS_API_KEY with your actual key) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Check authentication on page load
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                // User not logged in, redirect to login with return URL
                localStorage.setItem('returnUrl', 'checkout.html');
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Load cart from localStorage (using consistent key with index.html)
        function loadCart() {
            return JSON.parse(localStorage.getItem('cartItems') || '[]');
        }

        // Display cart items in checkout
        function displayCartItems() {
            const cart = loadCart();
            const cartContainer = document.getElementById('cart-items');
            const cartCountDisplay = document.getElementById('cart-count-display');

            // Update cart count display
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (cartCountDisplay) {
                cartCountDisplay.textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
            }

            if (cart.length === 0) {
                console.log('Cart is empty, showing empty message');
                cartContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-shopping-cart text-5xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">Your cart is empty</p>
                        <button onclick="window.location.href='index.html'" 
                            class="mt-4 bg-orange-500 text-white px-6 py-2 rounded-lg hover:bg-orange-600 transition-all duration-300">
                            Add Items
                        </button>
                    </div>
                `;
                return;
            }

            cartContainer.innerHTML = cart.map((item, index) => `
                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg bg-gray-50 cart-item" data-item-id="${item.id}">
                    <div class="flex items-center space-x-4">
                        <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-lg">
                        <div>
                            <h4 class="font-medium text-gray-800">${item.name}</h4>
                            <p class="text-sm text-gray-600">${item.restaurant}</p>
                            <p class="text-sm text-orange-500 font-medium">₹${item.price.toFixed(2)} each</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Quantity Controls -->
                        <div class="flex items-center space-x-2 bg-white rounded-lg border border-gray-300 p-1">
                            <button onclick="updateQuantity(${item.id}, ${item.quantity - 1})" 
                                class="w-8 h-8 bg-orange-500 text-white rounded-full hover:bg-orange-600 transition-all duration-300 flex items-center justify-center ${item.quantity <= 1 ? 'opacity-50 cursor-not-allowed' : ''}">
                                <i class="fas fa-minus text-sm"></i>
                            </button>
                            <span class="font-semibold text-lg min-w-[2rem] text-center">${item.quantity}</span>
                            <button onclick="updateQuantity(${item.id}, ${item.quantity + 1})" 
                                class="w-8 h-8 bg-orange-500 text-white rounded-full hover:bg-orange-600 transition-all duration-300 flex items-center justify-center">
                                <i class="fas fa-plus text-sm"></i>
                            </button>
                        </div>
                        <!-- Price and Remove -->
                        <div class="text-right">
                            <p class="font-bold text-lg text-gray-800">₹${(item.price * item.quantity).toFixed(2)}</p>
                            <button onclick="removeItem(${item.id})" 
                                class="text-red-500 hover:text-red-700 transition-all duration-300 text-sm mt-1">
                                <i class="fas fa-trash mr-1"></i>Remove
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            updateOrderSummary();
        }

        // Update order summary
        function updateOrderSummary() {
            const cart = loadCart();
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const deliveryFee = subtotal > 0 ? 40 : 0;
            const taxes = subtotal * 0.05; // 5% tax
            const total = subtotal + deliveryFee + taxes;

            document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('delivery-fee').textContent = `₹${deliveryFee.toFixed(2)}`;
            document.getElementById('taxes').textContent = `₹${taxes.toFixed(2)}`;
            document.getElementById('total-amount').textContent = `₹${total.toFixed(2)}`;
        }

        // Update item quantity
        function updateQuantity(itemId, newQuantity) {
            if (newQuantity <= 0) {
                removeItem(itemId);
                return;
            }

            let cart = loadCart();
            const itemIndex = cart.findIndex(item => item.id === itemId);

            if (itemIndex !== -1) {
                cart[itemIndex].quantity = newQuantity;
                localStorage.setItem('cartItems', JSON.stringify(cart));
                displayCartItems();
                showAlert('Cart updated successfully!', 'success');
            }
        }

        // Remove item from cart
        function removeItem(itemId) {
            let cart = loadCart();
            cart = cart.filter(item => item.id !== itemId);
            localStorage.setItem('cartItems', JSON.stringify(cart));
            displayCartItems();
            showAlert('Item removed from cart', 'success');

            // If cart becomes empty, show empty state
            if (cart.length === 0) {
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        }

        // Show alert function
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            const bgColor = {
                'success': 'bg-green-600',
                'error': 'bg-red-600',
                'warning': 'bg-yellow-600',
                'info': 'bg-blue-600'
            }[type] || 'bg-blue-600';

            alertDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 text-white transition-all duration-300 transform translate-x-full ${bgColor}`;
            alertDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(alertDiv);

            // Slide in
            setTimeout(() => {
                alertDiv.classList.remove('translate-x-full');
            }, 100);

            // Auto remove after 4 seconds
            setTimeout(() => {
                alertDiv.classList.add('translate-x-full');
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 300);
            }, 4000);
        }

        // Apply coupon
        document.getElementById('apply-coupon').addEventListener('click', function () {
            const couponCode = document.getElementById('coupon-code').value.trim();
            const messageEl = document.getElementById('coupon-message');

            if (!couponCode) {
                messageEl.innerHTML = '<span class="text-red-500">Please enter a coupon code</span>';
                return;
            }

            // Sample coupon validation
            const validCoupons = {
                'SAVE10': { discount: 10, type: 'percentage' },
                'FLAT50': { discount: 50, type: 'flat' },
                'WELCOME20': { discount: 20, type: 'percentage' }
            };

            if (validCoupons[couponCode.toUpperCase()]) {
                const coupon = validCoupons[couponCode.toUpperCase()];
                let discount = 0;

                const cart = loadCart();
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                if (coupon.type === 'percentage') {
                    discount = subtotal * (coupon.discount / 100);
                } else {
                    discount = coupon.discount;
                }

                document.getElementById('discount-row').classList.remove('hidden');
                document.getElementById('discount').textContent = `-₹${discount.toFixed(2)}`;
                messageEl.innerHTML = '<span class="text-green-500">Coupon applied successfully!</span>';

                // Update total
                const deliveryFee = 40;
                const taxes = subtotal * 0.05;
                const total = subtotal + deliveryFee + taxes - discount;
                document.getElementById('total-amount').textContent = `₹${total.toFixed(2)}`;
            } else {
                messageEl.innerHTML = '<span class="text-red-500">Invalid coupon code</span>';
            }
        });

        // Place order
        document.getElementById('place-order').addEventListener('click', function () {
            const fullName = document.getElementById('fullName').value;
            const mobile = document.getElementById('mobile').value;
            const street = document.getElementById('street').value;
            const city = document.getElementById('city').value;
            const state = document.getElementById('state').value;
            const pincode = document.getElementById('pincode').value;
            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
            const deliveryInstructions = document.getElementById('deliveryInstructions').value;

            if (!fullName || !mobile || !street || !city || !state || !pincode) {
                showAlert('Please fill all address fields', 'error');
                return;
            }
            if (mobile.length !== 10) {
                showAlert('Please enter a valid 10-digit mobile number', 'error');
                return;
            }
            if (pincode.length !== 6) {
                showAlert('Please enter a valid 6-digit pincode', 'error');
                return;
            }
            const cart = loadCart();
            if (cart.length === 0) {
                showAlert('Your cart is empty', 'error');
                return;
            }

            // Save order details if needed (optional)
            localStorage.setItem('lastOrder', JSON.stringify({
                fullName, mobile, street, city, state, pincode, paymentMethod, deliveryInstructions, cart
            }));

            // Clear cart and redirect to confirmation page
            localStorage.removeItem('cartItems');
            showAlert('🎉 Order placed successfully! You will receive a confirmation shortly.', 'success');
            setTimeout(() => {
                window.location.href = 'order-success.html';
            }, 1200);
        });

        // Check if user is logged in
        function isLoggedIn() {
            return !!localStorage.getItem('token');
        }

        let map, marker;

        function initOpenStreetMap() {
            const defaultLatLng = [17.385044, 78.486671]; // Hyderabad [lat, lng]
            map = L.map('map').setView(defaultLatLng, 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(map);

            marker = L.marker(defaultLatLng, { draggable: true }).addTo(map);

            map.on('click', function(e) {
                marker.setLatLng(e.latlng);
                reverseGeocodeOSM(e.latlng);
            });

            marker.on('dragend', function() {
                reverseGeocodeOSM(marker.getLatLng());
            });

            document.getElementById('map').style.display = 'block';
        }

        function reverseGeocodeOSM(latlng) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latlng.lat}&lon=${latlng.lng}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById("location-message").textContent = "Location selected!";
                    fillAddressFieldsOSM(data.address, data.display_name);
                })
                .catch(() => {
                    document.getElementById("location-message").textContent = "Could not get address for this location.";
                });
        }

        function fillAddressFieldsOSM(address, displayName) {
            document.getElementById("street").value = displayName || '';
            document.getElementById("city").value = address.city || address.town || address.village || '';
            document.getElementById("state").value = address.state || '';
            document.getElementById("pincode").value = address.postcode || '';
        }

        document.getElementById("use-location-btn").addEventListener("click", function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (pos) {
                    const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    marker.setLatLng(latlng);
                    map.setView(latlng, 16);
                    reverseGeocodeOSM(latlng);
                    document.getElementById("location-message").textContent = "Using your current location!";
                }, function () {
                    document.getElementById("location-message").textContent = "Unable to get your location.";
                });
            } else {
                document.getElementById("location-message").textContent = "Geolocation is not supported.";
            }
        });

        function loadSavedAddresses() {
            const addresses = JSON.parse(localStorage.getItem('savedAddresses') || '[]');
            const select = document.getElementById('saved-addresses');
            select.innerHTML = '<option value="">Select a saved address</option>';
            addresses.forEach((addr, i) => {
                select.innerHTML += `<option value="${i}">${addr.fullName}, ${addr.street}, ${addr.city}, ${addr.state} - ${addr.pincode}</option>`;
            });
        }

        document.getElementById('saved-addresses').addEventListener('change', function () {
            const addresses = JSON.parse(localStorage.getItem('savedAddresses') || '[]');
            const idx = this.value;
            if (idx !== "") {
                const addr = addresses[idx];
                document.getElementById('fullName').value = addr.fullName;
                document.getElementById('mobile').value = addr.mobile;
                document.getElementById('street').value = addr.street;
                document.getElementById('city').value = addr.city;
                document.getElementById('state').value = addr.state;
                document.getElementById('pincode').value = addr.pincode;
            }
        });

        document.getElementById('save-address-btn').addEventListener('click', function () {
            const addr = {
                fullName: document.getElementById('fullName').value,
                mobile: document.getElementById('mobile').value,
                street: document.getElementById('street').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                pincode: document.getElementById('pincode').value
            };
            if (!addr.fullName || !addr.mobile || !addr.street || !addr.city || !addr.state || !addr.pincode) {
                showAlert('Fill all address fields before saving!', 'warning');
                return;
            }
            const addresses = JSON.parse(localStorage.getItem('savedAddresses') || '[]');
            addresses.push(addr);
            localStorage.setItem('savedAddresses', JSON.stringify(addresses));
            loadSavedAddresses();
            showAlert('Address saved!', 'success');
        });

        // Use This Address button: fills form with selected saved address
        document.getElementById('use-address-btn').addEventListener('click', function () {
            const addresses = JSON.parse(localStorage.getItem('savedAddresses') || '[]');
            const idx = document.getElementById('saved-addresses').value;
            if (idx !== "") {
                const addr = addresses[idx];
                document.getElementById('fullName').value = addr.fullName;
                document.getElementById('mobile').value = addr.mobile;
                document.getElementById('street').value = addr.street;
                document.getElementById('city').value = addr.city;
                document.getElementById('state').value = addr.state;
                document.getElementById('pincode').value = addr.pincode;
                showAlert('Address loaded!', 'success');
            }
        });

        // Show Save Address button only when address fields are filled
        function toggleSaveAddressBtn() {
            const fullName = document.getElementById('fullName').value;
            const mobile = document.getElementById('mobile').value;
            const street = document.getElementById('street').value;
            const city = document.getElementById('city').value;
            const state = document.getElementById('state').value;
            const pincode = document.getElementById('pincode').value;
            const btn = document.getElementById('save-address-btn');
            if (fullName && mobile && street && city && state && pincode) {
                btn.style.display = 'block';
            } else {
                btn.style.display = 'none';
            }
        }
        ['fullName', 'mobile', 'street', 'city', 'state', 'pincode'].forEach(id => {
            document.getElementById(id).addEventListener('input', toggleSaveAddressBtn);
        });
        toggleSaveAddressBtn();

        // Initialize page
        window.onload = function () {
            if (!checkAuth()) return;
            displayCartItems();
            initOpenStreetMap();
            loadSavedAddresses();
        };

        document.getElementById('delete-address-btn').addEventListener('click', function () {
            const select = document.getElementById('saved-addresses');
            const idx = select.value;
            if (idx === "") {
                showAlert('Please select an address to delete.', 'warning');
                return;
            }
            let addresses = JSON.parse(localStorage.getItem('savedAddresses') || '[]');
            addresses.splice(idx, 1);
            localStorage.setItem('savedAddresses', JSON.stringify(addresses));
            loadSavedAddresses();
            select.value = "";
            showAlert('Address deleted!', 'success');
        });
    </script>
</body>

</html>