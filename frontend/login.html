<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VitalBites - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Animation for fade in */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Pulse animation */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 136, 0, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 136, 0, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 136, 0, 0);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Shake animation */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-5px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(5px);
            }
        }

        .shake {
            animation: shake 0.5s;
        }

        .error-border {
            border-color: #ef4444 !important;
        }

        /* Enable dark mode for the entire page */
        body,
        .bg-gray-50,
        .bg-white {
            background-color: #18181b !important;
            color: #f3f4f6 !important;
        }

        .text-gray-800,
        .text-gray-700,
        .text-gray-600,
        .text-gray-500,
        .text-gray-400,
        .text-gray-900 {
            color: #f3f4f6 !important;
        }

        .bg-white,
        .bg-gray-100,
        .bg-orange-100 {
            background-color: #23232a !important;
        }

        .rounded-xl {
            background-clip: padding-box;
        }

        .hover\:bg-gray-100:hover,
        .hover\:bg-gray-300:hover,
        .hover\:bg-gray-900:hover {
            background-color: #23232a !important;
        }

        .bg-orange-500,
        .hover\:bg-orange-500:hover,
        .hover\:bg-orange-600:hover,
        .bg-orange-600 {
            background-color: #ff8800 !important;
        }

        .text-orange-500 {
            color: #ff8800 !important;
        }

        .bg-gray-200 {
            background-color: #23232a !important;
        }

        .bg-gray-800 {
            background-color: #18181b !important;
        }

        .bg-black {
            background-color: #101014 !important;
        }

        .text-white {
            color: #f3f4f6 !important;
        }

        .text-red-500 {
            color: #ff4d4f !important;
        }

        .bg-gray-900,
        .hover\:bg-gray-800:hover {
            background-color: #101014 !important;
        }

        input,
        textarea,
        select {
            background-color: #23232a !important;
            color: #f3f4f6 !important;
            border-color: #2d2d36 !important;
        }

        /* Scrollbar dark */
        ::-webkit-scrollbar {
            background: #23232a;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
        }

        /* Button hover effects */
        .btn-primary {
            background-color: #ff8800;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #e67a00;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 136, 0, 0.2);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .input-field {
            background-color: #23232a;
            color: #f3f4f6;
            border-color: #2d2d36;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            border-color: #ff8800;
            box-shadow: 0 0 0 3px rgba(255, 136, 0, 0.2);
        }

        .country-code {
            background-color: #2d2d36;
            color: #f3f4f6;
            border-color: #2d2d36;
        }

        .bg-card {
            background-color: #23232a;
            background-image: radial-gradient(circle at 25% 25%, #2d2d36 0%, #23232a 100%);
        }
    </style>
</head>

<body class="bg-gray-50 font-sans min-h-screen flex flex-col">
    <!-- Header with Logo -->
    <!-- Header -->
    <header class="bg-gray-900 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Brand Logo -->
                <div class="flex items-center space-x-2 cursor-pointer" onclick="window.location.href='index.html'">
                    <div>
                        <h1
                            class="text-2xl font-bold bg-gradient-to-r from-orange-400 to-red-500 bg-clip-text text-transparent">
                            VitalBites
                        </h1>
                        <p class="text-xs text-gray-400 hidden sm:block">Fresh • Fast • Delicious</p>
                    </div>
                </div>

                <!-- Progress Indicator -->
                <div id="progress-container" class="hidden sm:flex items-center space-x-2 lg:space-x-4 text-sm">
                    <div class="flex items-center space-x-1 lg:space-x-2">
                        <div id="step1"
                            class="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-white text-sm font-bold shadow-lg">
                            1</div>
                        <span class="text-gray-300 hidden lg:block">Email</span>
                    </div>
                    <div class="w-6 lg:w-8 h-0.5 bg-gray-600 rounded"></div>
                    <div class="flex items-center space-x-1 lg:space-x-2">
                        <div id="step2"
                            class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-gray-400 text-sm font-bold transition-all duration-300">
                            2</div>
                        <span class="text-gray-400 hidden lg:block">Verify</span>
                    </div>
                    <div class="w-6 lg:w-8 h-0.5 bg-gray-600 rounded"></div>
                    <div class="flex items-center space-x-1 lg:space-x-2">
                        <div id="step3"
                            class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-gray-400 text-sm font-bold transition-all duration-300">
                            3</div>
                        <span class="text-gray-400 hidden lg:block">Complete</span>
                    </div>
                </div>

                <!-- Back to Home -->
                <button onclick="window.location.href='index.html'"
                    class="flex items-center space-x-2 text-gray-300 hover:text-white transition-all duration-300 p-3 rounded-lg hover:bg-gray-700 bg-gray-800">
                    <i class="fas fa-arrow-left text-lg"></i>
                    <span class="hidden sm:block font-medium">Back to Home</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex items-center justify-center p-4 bg-gray-50">
        <div
            class="bg-card rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-sm sm:max-w-md fade-in relative overflow-hidden backdrop-blur-sm border border-gray-700">
            <!-- Decorative elements -->
            <div
                class="absolute -top-20 -right-20 w-40 h-40 rounded-full bg-gradient-to-br from-orange-500 to-red-500 opacity-10">
            </div>
            <div
                class="absolute -bottom-20 -left-20 w-40 h-40 rounded-full bg-gradient-to-br from-orange-500 to-red-500 opacity-10">
            </div>
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500 to-red-500"></div>

            <div class="relative z-10">
                <div class="text-center mb-6 sm:mb-8">
                    <h2 class="text-2xl sm:text-3xl font-bold text-white mb-2">Welcome Back!</h2>
                    <p class="text-gray-400 text-sm sm:text-base">Sign in to continue your culinary journey</p>
                </div>

                <form id="loginForm" class="space-y-6">
                    <!-- Email Section -->
                    <div id="emailSection">
                        <div class="space-y-6">
                            <div class="relative">
                                <label for="email" class="block mb-3 text-sm font-medium text-gray-300">
                                    <i class="fas fa-envelope mr-3 text-orange-500 text-lg"></i>
                                    Email Address
                                </label>
                                <input type="email" id="email" name="email" required
                                    class="w-full px-5 py-4 rounded-xl border input-field focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-300 text-white placeholder-gray-500 text-lg"
                                    placeholder="Enter your email address">
                                <div id="emailError" class="hidden mt-2 text-red-400 text-sm"></div>
                            </div>

                            <button type="button" id="sendOtpBtn"
                                class="w-full btn-primary py-4 rounded-xl font-semibold flex items-center justify-center space-x-3 text-lg transition-all duration-300 transform hover:scale-105 shadow-lg">
                                <span>Send Verification Code</span>
                                <i class="fas fa-paper-plane ml-2"></i>
                            </button>
                        </div>

                        <div class="mt-8 text-center space-y-4">
                            <p class="text-sm text-gray-400">New to VitalBites? Just enter your email to get started!
                            </p>
                            <p class="text-xs text-gray-500 leading-relaxed px-4">
                                By continuing, you agree to our
                                <a href="terms.html"
                                    class="text-orange-400 hover:text-orange-300 underline transition-colors">Terms of
                                    Service</a> and
                                <a href="privacy.html"
                                    class="text-orange-400 hover:text-orange-300 underline transition-colors">Privacy
                                    Policy</a>
                            </p>
                        </div>
                    </div>

                    <!-- OTP Section -->
                    <div id="otpSection" class="hidden">
                        <div class="space-y-6">
                            <div class="text-center">
                                <h3 class="text-2xl font-semibold text-white mb-3">Verify Your Email</h3>
                                <p class="text-gray-400 mb-2">We've sent a 6-digit code to</p>
                                <p class="text-orange-400 font-medium text-lg" id="emailDisplay"></p>
                                <button type="button" id="changeEmail"
                                    class="text-orange-400 text-sm hover:text-orange-300 underline mt-3 transition-colors font-medium">
                                    Change email
                                </button>
                            </div>

                            <div>
                                <label class="block mb-5 text-sm font-medium text-gray-300 text-center">
                                    <i class="fas fa-key mr-3 text-orange-500 text-lg"></i>
                                    Enter 6-digit verification code
                                </label>
                                <div class="flex space-x-2 justify-center">
                                    <input type="text" maxlength="1" pattern="[0-9]"
                                        class="w-12 h-12 sm:w-14 sm:h-14 text-center text-xl sm:text-2xl font-bold rounded-xl border-2 border-gray-600 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-300 otp-digit">
                                    <input type="text" maxlength="1" pattern="[0-9]"
                                        class="w-12 h-12 sm:w-14 sm:h-14 text-center text-xl sm:text-2xl font-bold rounded-xl border-2 border-gray-600 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-300 otp-digit">
                                    <input type="text" maxlength="1" pattern="[0-9]"
                                        class="w-12 h-12 sm:w-14 sm:h-14 text-center text-xl sm:text-2xl font-bold rounded-xl border-2 border-gray-600 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-300 otp-digit">
                                    <input type="text" maxlength="1" pattern="[0-9]"
                                        class="w-12 h-12 sm:w-14 sm:h-14 text-center text-xl sm:text-2xl font-bold rounded-xl border-2 border-gray-600 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-300 otp-digit">
                                    <input type="text" maxlength="1" pattern="[0-9]"
                                        class="w-12 h-12 sm:w-14 sm:h-14 text-center text-xl sm:text-2xl font-bold rounded-xl border-2 border-gray-600 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-300 otp-digit">
                                    <input type="text" maxlength="1" pattern="[0-9]"
                                        class="w-12 h-12 sm:w-14 sm:h-14 text-center text-xl sm:text-2xl font-bold rounded-xl border-2 border-gray-600 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-300 otp-digit">
                                </div>
                                <input type="hidden" id="otp" name="otp">
                                <div id="otpError" class="hidden mt-4 text-red-400 text-sm text-center"></div>
                            </div>

                            <button type="submit" id="verifyOtpBtn"
                                class="w-full btn-primary py-4 rounded-xl font-semibold flex items-center justify-center space-x-3 text-lg transition-all duration-300 transform hover:scale-105 shadow-lg">
                                <span>Verify & Continue</span>
                                <i class="fas fa-arrow-right ml-2"></i>
                            </button>

                            <div class="text-center space-y-3">
                                <p class="text-sm text-gray-400">
                                    Didn't receive the code?
                                </p>
                                <button type="button" id="resendOtp"
                                    class="text-orange-400 hover:text-orange-300 font-medium transition-colors text-base">
                                    Resend verification code
                                </button>
                                <p id="countdown" class="text-xs text-gray-500 hidden">
                                    <i class="fas fa-clock mr-2"></i>
                                    Resend available in <span id="timer" class="font-medium text-orange-400">30</span>
                                    seconds
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- User Details Section (for new users) -->
                    <div id="userDetailsSection" class="hidden">
                        <div class="space-y-6">
                            <div class="text-center mb-6">
                                <h3 class="text-2xl font-bold text-white mb-3">Complete Your Profile</h3>
                                <p class="text-gray-400">Just a few more details to get you started</p>
                            </div>

                            <div class="relative">
                                <label for="userName" class="block mb-4 text-sm font-medium text-gray-300">
                                    <i class="fas fa-user mr-3 text-orange-500 text-lg"></i>
                                    Full Name
                                </label>
                                <input type="text" id="userName" name="userName" required
                                    class="w-full px-5 py-4 rounded-xl border-2 border-gray-600 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-300 placeholder-gray-500 text-lg"
                                    placeholder="Enter your full name">
                                <div id="nameError" class="hidden mt-2 text-red-400 text-sm"></div>
                                <div id="nameSuccess" class="hidden mt-2 text-green-400 text-sm flex items-center">
                                    <i class="fas fa-check mr-2"></i>
                                    Name looks good!
                                </div>
                            </div>

                            <div class="relative">
                                <label for="userMobile" class="block mb-4 text-sm font-medium text-gray-300">
                                    <i class="fas fa-mobile-alt mr-3 text-orange-500 text-lg"></i>
                                    Mobile Number
                                </label>
                                <div class="flex">
                                    <span
                                        class="inline-flex items-center px-4 rounded-l-xl border-2 border-r-0 border-gray-600 bg-gray-700 text-gray-300 font-medium text-lg">
                                        +91
                                    </span>
                                    <input type="tel" id="userMobile" name="userMobile" required
                                        class="w-full px-5 py-4 rounded-r-xl border-2 border-gray-600 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-300 placeholder-gray-500 text-lg"
                                        placeholder="Enter 10-digit number" maxlength="10" pattern="[6-9][0-9]{9}">
                                </div>
                                <div id="mobileError" class="hidden mt-2 text-red-400 text-sm"></div>
                                <div id="mobileSuccess" class="hidden mt-2 text-green-400 text-sm flex items-center">
                                    <i class="fas fa-check mr-2"></i>
                                    Mobile number is valid!
                                </div>
                            </div>

                            <button type="button" id="completeRegistrationBtn"
                                class="w-full btn-primary py-4 rounded-xl font-semibold flex items-center justify-center space-x-3 text-lg transition-all duration-300 transform hover:scale-105 shadow-lg">
                                <span>Complete Registration</span>
                                <i class="fas fa-arrow-right ml-2"></i>
                            </button>

                            <div class="text-center">
                                <button type="button" id="backToOtp"
                                    class="text-orange-400 text-sm hover:text-orange-300 underline transition-colors font-medium">
                                    <i class="fas fa-arrow-left mr-2"></i>Back to verification
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-[#18181b] py-6">
        <div class="container mx-auto px-6 text-center text-gray-400 text-sm">
            <p>© 2025 VitalBites. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Progress Indicator Functions
        function updateProgress(step) {
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');

            // Reset all steps
            [step1, step2, step3].forEach(s => {
                s.className = 'w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold';
            });

            if (step >= 1) {
                step1.classList.add('bg-orange-500', 'text-white');
                step1.innerHTML = '<i class="fas fa-check text-xs"></i>';
            } else {
                step1.classList.add('bg-gray-600', 'text-gray-400');
                step1.textContent = '1';
            }

            if (step >= 2) {
                step2.classList.add('bg-orange-500', 'text-white');
                if (step === 2) {
                    step2.textContent = '2';
                } else {
                    step2.innerHTML = '<i class="fas fa-check text-xs"></i>';
                }
            } else {
                step2.classList.add('bg-gray-600', 'text-gray-400');
                step2.textContent = '2';
            }

            if (step >= 3) {
                step3.classList.add('bg-orange-500', 'text-white');
                step3.textContent = '3';
            } else {
                step3.classList.add('bg-gray-600', 'text-gray-400');
                step3.textContent = '3';
            }
        }

        // DOM Elements
        const emailSection = document.getElementById('emailSection');
        const otpSection = document.getElementById('otpSection');
        const userDetailsSection = document.getElementById('userDetailsSection');
        const sendOtpBtn = document.getElementById('sendOtpBtn');
        const verifyOtpBtn = document.getElementById('verifyOtpBtn');
        const completeRegistrationBtn = document.getElementById('completeRegistrationBtn');
        const loginForm = document.getElementById('loginForm');
        const resendOtp = document.getElementById('resendOtp');
        const changeEmail = document.getElementById('changeEmail');
        const backToOtp = document.getElementById('backToOtp');
        const emailInput = document.getElementById('email');
        const otpInput = document.getElementById('otp');
        const userNameInput = document.getElementById('userName');
        const userMobileInput = document.getElementById('userMobile');
        const emailDisplay = document.getElementById('emailDisplay');
        const countdown = document.getElementById('countdown');
        const timer = document.getElementById('timer');
        const otpDigits = document.querySelectorAll('.otp-digit');
        const emailError = document.getElementById('emailError');
        const otpError = document.getElementById('otpError');
        const nameError = document.getElementById('nameError');
        const mobileError = document.getElementById('mobileError');
        const nameSuccess = document.getElementById('nameSuccess');
        const mobileSuccess = document.getElementById('mobileSuccess');

        // Real-time validation for name input
        userNameInput.addEventListener('input', function (e) {
            const name = e.target.value.trim();

            // Clear previous states
            nameError.classList.add('hidden');
            nameSuccess.classList.add('hidden');
            e.target.classList.remove('border-red-500', 'border-green-500');

            if (name.length === 0) {
                return; // Don't validate empty input
            }

            if (name.length < 2) {
                showFieldError('name', 'Name must be at least 2 characters long');
                return;
            }

            if (name.length > 50) {
                showFieldError('name', 'Name must be less than 50 characters');
                return;
            }

            if (!/^[a-zA-Z\s]*$/.test(name)) {
                showFieldError('name', 'Name can only contain letters and spaces');
                return;
            }

            // Valid name
            showFieldSuccess('name');
        });

        // Real-time validation for mobile input
        userMobileInput.addEventListener('input', function (e) {
            let value = e.target.value.replace(/[^0-9]/g, ''); // Only allow numbers
            e.target.value = value;

            // Clear previous states
            mobileError.classList.add('hidden');
            mobileSuccess.classList.add('hidden');
            e.target.classList.remove('border-red-500', 'border-green-500');

            if (value.length === 0) {
                return; // Don't validate empty input
            }

            if (value.length < 10) {
                showFieldError('mobile', `Enter ${10 - value.length} more digit${10 - value.length > 1 ? 's' : ''}`);
                return;
            }

            if (value.length === 10) {
                if (!/^[6-9]/.test(value)) {
                    showFieldError('mobile', 'Mobile number must start with 6, 7, 8, or 9');
                    return;
                }

                // Valid mobile
                showFieldSuccess('mobile');
            }
        });

        // Helper functions for field validation
        function showFieldError(field, message) {
            if (field === 'name') {
                nameError.textContent = message;
                nameError.classList.remove('hidden');
                userNameInput.classList.add('border-red-500');
            } else if (field === 'mobile') {
                mobileError.textContent = message;
                mobileError.classList.remove('hidden');
                userMobileInput.classList.add('border-red-500');
            }
        }

        function showFieldSuccess(field) {
            if (field === 'name') {
                nameSuccess.classList.remove('hidden');
                userNameInput.classList.add('border-green-500');
            } else if (field === 'mobile') {
                mobileSuccess.classList.remove('hidden');
                userMobileInput.classList.add('border-green-500');
            }
        }

        // OTP Digit Input Handling
        otpDigits.forEach((digit, index) => {
            digit.addEventListener('input', (e) => {
                if (e.target.value.length === 1) {
                    if (index < otpDigits.length - 1) {
                        otpDigits[index + 1].focus();
                    } else {
                        digit.blur();
                    }
                }

                // Update hidden otp field
                updateHiddenOtp();
            });

            digit.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && e.target.value.length === 0 && index > 0) {
                    otpDigits[index - 1].focus();
                }
            });
        });

        function updateHiddenOtp() {
            let otp = '';
            otpDigits.forEach(digit => {
                otp += digit.value;
            });
            otpInput.value = otp;
            console.log('Updated hidden OTP:', otp, 'Length:', otp.length);
        }

        // Email validation function
        function isValidEmail(email) {
            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            return emailPattern.test(email);
        }

        // Indian mobile number validation
        function isValidIndianMobile(mobile) {
            const mobilePattern = /^[6-9]\d{9}$/;
            return mobilePattern.test(mobile);
        }

        // Name validation
        function isValidName(name) {
            const namePattern = /^[a-zA-Z\s]{2,50}$/;
            return namePattern.test(name.trim());
        }

        // Send OTP
        sendOtpBtn.onclick = async function () {
            const email = emailInput.value.trim();

            if (!email) {
                showError(emailInput, emailError, 'Please enter your email address');
                return;
            }

            if (!isValidEmail(email)) {
                showError(emailInput, emailError, 'Please enter a valid email address');
                return;
            }

            sendOtpBtn.disabled = true;
            sendOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending OTP...';

            try {
                const res = await fetch('/api/auth/send-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                if (res.ok) {
                    updateProgress(2);
                    emailDisplay.textContent = email;
                    emailSection.classList.add('hidden');
                    otpSection.classList.remove('hidden');
                    otpSection.classList.add('animate__animated', 'animate__fadeIn');
                    startCountdown();
                    otpDigits[0].focus();
                } else {
                    showError(emailInput, emailError, data.error || 'Failed to send OTP');
                }
            } catch (err) {
                showError(emailInput, emailError, 'Network error. Please check your connection.');
            } finally {
                sendOtpBtn.disabled = false;
                sendOtpBtn.innerHTML = '<span>Send OTP</span> <i class="fas fa-paper-plane"></i>';
            }
        };

        // Resend OTP
        resendOtp.onclick = function (e) {
            e.preventDefault();

            if (countdown.classList.contains('hidden')) {
                sendOtpBtn.onclick();
            }
        };

        // Change Email
        changeEmail.onclick = function (e) {
            e.preventDefault();
            otpSection.classList.add('hidden');
            emailSection.classList.remove('hidden');
            emailSection.classList.add('animate__animated', 'animate__fadeIn');

            // Clear OTP fields
            otpDigits.forEach(digit => {
                digit.value = '';
            });
            updateHiddenOtp();
        };

        // Verify OTP
        loginForm.onsubmit = async function (e) {
            e.preventDefault();
            console.log('Form submitted - OTP verification started');

            // Update the hidden OTP field first
            updateHiddenOtp();

            const email = emailInput.value.trim();
            const otp = otpInput.value;

            console.log('Email:', email, 'OTP:', otp);

            if (otp.length !== 6) {
                console.log('Invalid OTP length:', otp.length);
                showError(otpDigits[0], otpError, 'Please enter a valid 6-digit OTP');
                otpDigits.forEach(digit => {
                    digit.classList.add('shake');
                    setTimeout(() => {
                        digit.classList.remove('shake');
                    }, 500);
                });
                return;
            }

            console.log('OTP validation passed, sending request...');
            verifyOtpBtn.disabled = true;
            verifyOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

            try {
                const res = await fetch('/api/auth/verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, otp })
                });
                const data = await res.json();

                console.log('API Response:', data);
                console.log('Response status:', res.ok);
                console.log('needDetails:', data.needDetails);
                console.log('isNewUser:', data.isNewUser);
                console.log('token:', data.token);

                if (res.ok) {
                    if (data.needDetails || data.isNewUser) {
                        console.log('New user - showing details form');
                        updateProgress(3);
                        // Store email for completing registration
                        localStorage.setItem('tempUserEmail', email);
                        // New user - show details form
                        otpSection.classList.add('hidden');
                        userDetailsSection.classList.remove('hidden');
                        userDetailsSection.classList.add('animate__animated', 'animate__fadeIn');
                    } else if (data.token) {
                        console.log('Existing user - redirecting');
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('userEmail', email);
                        if (data.userId) localStorage.setItem('userId', data.userId);
                        if (data.username) localStorage.setItem('username', data.username);

                        setTimeout(() => {
                            // Check for return URL first
                            const returnUrl = localStorage.getItem('returnUrl') || new URLSearchParams(window.location.search).get('returnUrl');
                            if (returnUrl) {
                                localStorage.removeItem('returnUrl');
                                window.location.href = returnUrl;
                            } else {
                                window.location.href = 'index.html';
                            }
                        }, 1500);
                    } else {
                        console.log('Unexpected response format:', data);
                        showError(otpDigits[0], otpError, 'Unexpected server response');
                    }
                } else {
                    console.log('OTP verification failed:', data.error);
                    showError(otpDigits[0], otpError, data.error || 'OTP verification failed');
                }
            } catch (err) {
                console.error('Network error:', err);
                showError(otpDigits[0], otpError, 'Network error. Please try again.');
            } finally {
                verifyOtpBtn.disabled = false;
                verifyOtpBtn.innerHTML = '<span>Verify OTP</span> <i class="fas fa-check"></i>';
            }
        };

        // Add direct click handler for verify button
        verifyOtpBtn.addEventListener('click', function (e) {
            console.log('Verify button clicked');
            e.preventDefault();
            e.stopPropagation();

            // Update hidden OTP field
            updateHiddenOtp();

            // Check if we have 6 digits
            const otpValue = otpInput.value;
            console.log('Current OTP value:', otpValue, 'Length:', otpValue.length);

            if (otpValue.length === 6) {
                console.log('OTP length is correct, triggering form submission');
                // Trigger form submission
                const formEvent = new Event('submit', { cancelable: true });
                loginForm.dispatchEvent(formEvent);
            } else {
                console.log('OTP length is incorrect:', otpValue.length);
                showError(otpDigits[0], otpError, 'Please enter all 6 digits');
            }
        });

        // Complete Registration
        completeRegistrationBtn.onclick = async function () {
            console.log('Complete registration button clicked');

            // Use the stored email from OTP verification
            const email = localStorage.getItem('tempUserEmail') || emailInput.value.trim();
            const name = userNameInput.value.trim();
            const mobile = userMobileInput.value.trim();

            console.log('Registration data:', { email, name, mobile });

            // Clear previous errors
            nameError.classList.add('hidden');
            mobileError.classList.add('hidden');
            userNameInput.classList.remove('border-red-500');
            userMobileInput.classList.remove('border-red-500');

            let hasErrors = false;

            // Validate name
            if (!name) {
                showFieldError('name', 'Please enter your full name');
                hasErrors = true;
            } else if (!isValidName(name)) {
                showFieldError('name', 'Name must be 2-50 characters with letters only');
                hasErrors = true;
            }

            // Validate mobile
            if (!mobile) {
                showFieldError('mobile', 'Please enter your mobile number');
                hasErrors = true;
            } else if (!isValidIndianMobile(mobile)) {
                showFieldError('mobile', 'Please enter a valid 10-digit mobile number starting with 6-9');
                hasErrors = true;
            }

            if (hasErrors) {
                console.log('Validation failed');
                return;
            }

            console.log('Validation passed, sending registration request...');
            completeRegistrationBtn.disabled = true;
            completeRegistrationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Completing Registration...';

            try {
                const res = await fetch('/api/auth/complete-registration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email,
                        username: name,
                        mobile: `+91${mobile}`
                    })
                });
                const data = await res.json();

                console.log('Registration API Response:', data);
                console.log('Registration response status:', res.ok);

                if (res.ok && data.token) {
                    console.log('Registration successful, redirecting...');
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('userEmail', email);
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('userMobile', data.mobile);
                    if (data.userId) localStorage.setItem('userId', data.userId);

                    // Clean up temporary email
                    localStorage.removeItem('tempUserEmail');

                    setTimeout(() => {
                        // Check for return URL first
                        const returnUrl = localStorage.getItem('returnUrl') || new URLSearchParams(window.location.search).get('returnUrl');
                        if (returnUrl) {
                            localStorage.removeItem('returnUrl');
                            window.location.href = returnUrl;
                        } else {
                            window.location.href = 'index.html';
                        }
                    }, 1500);
                } else {
                    console.log('Registration failed:', data.error);
                    showFieldError('name', data.error || 'Registration failed. Please try again.');
                }
            } catch (err) {
                console.error('Registration network error:', err);
                showFieldError('name', 'Network error. Please check your connection.');
            } finally {
                completeRegistrationBtn.disabled = false;
                completeRegistrationBtn.innerHTML = '<span>Complete Registration</span> <i class="fas fa-arrow-right"></i>';
            }
        };        // Back to OTP
        backToOtp.onclick = function (e) {
            e.preventDefault();
            updateProgress(2);
            // Clear temporary email when going back
            localStorage.removeItem('tempUserEmail');
            userDetailsSection.classList.add('hidden');
            otpSection.classList.remove('hidden');
            otpSection.classList.add('animate__animated', 'animate__fadeIn');
        };

        // Helper Functions
        function showError(element, errorElement, message) {
            // Remove existing error if any
            if (errorElement.classList.contains('animate__fadeInDown')) {
                errorElement.classList.remove('animate__fadeInDown');
                errorElement.classList.add('animate__fadeOutUp');
                setTimeout(() => {
                    errorElement.classList.add('hidden');
                    element.classList.remove('error-border');
                }, 500);
            }

            // Create new error message
            errorElement.innerHTML = '';
            errorElement.className = 'text-red-400 text-sm mt-1 animate__animated animate__fadeInDown';
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');

            // Add error border
            element.classList.add('error-border');

            // Auto-remove after 5 seconds
            setTimeout(() => {
                errorElement.classList.remove('animate__fadeInDown');
                errorElement.classList.add('animate__fadeOutUp');
                setTimeout(() => {
                    errorElement.classList.add('hidden');
                    element.classList.remove('error-border');
                }, 500);
            }, 5000);
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 animate__animated animate__fadeInRight ${type === 'success' ? 'bg-green-600' : 'bg-red-600'
                } text-white`;
            alertDiv.textContent = message;

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.classList.remove('animate__fadeInRight');
                alertDiv.classList.add('animate__fadeOutUp');
                setTimeout(() => {
                    alertDiv.remove();
                }, 500);
            }, 3000);
        }

        // Mobile number input formatting
        userMobileInput.addEventListener('input', function (e) {
            // Remove non-numeric characters
            let value = e.target.value.replace(/\D/g, '');

            // Limit to 10 digits
            if (value.length > 10) {
                value = value.slice(0, 10);
            }

            e.target.value = value;
        });

        // Name input formatting (only letters and spaces)
        userNameInput.addEventListener('input', function (e) {
            // Remove numbers and special characters except spaces
            let value = e.target.value.replace(/[^a-zA-Z\s]/g, '');
            e.target.value = value;
        });

        function startCountdown() {
            let timeLeft = 30;
            countdown.classList.remove('hidden');

            const interval = setInterval(() => {
                timeLeft--;
                timer.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(interval);
                    countdown.classList.add('hidden');
                }
            }, 1000);
        }

        // Initialize progress on page load
        document.addEventListener('DOMContentLoaded', function () {
            updateProgress(1);
        });
    </script>
</body>

</html>