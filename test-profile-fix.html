<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Error Fix Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center">🔧 Profile Error Fix Test</h1>
        
        <!-- Test Status -->
        <div id="test-status" class="bg-gray-800 p-4 rounded-lg mb-6">
            <h2 class="text-xl font-semibold mb-3">Test Status</h2>
            <div id="test-results" class="space-y-2">
                <div class="text-yellow-400">🧪 Running tests...</div>
            </div>
        </div>

        <!-- Error Simulation -->
        <div class="bg-gray-800 p-4 rounded-lg mb-6">
            <h2 class="text-xl font-semibold mb-3">Error Simulation</h2>
            <div class="space-x-2">
                <button id="testNull" class="bg-red-600 px-4 py-2 rounded hover:bg-red-700">
                    Test Null Data
                </button>
                <button id="testEmpty" class="bg-orange-600 px-4 py-2 rounded hover:bg-orange-700">
                    Test Empty Arrays
                </button>
                <button id="testMixed" class="bg-purple-600 px-4 py-2 rounded hover:bg-purple-700">
                    Test Mixed Data
                </button>
                <button id="clearAllTest" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-700">
                    Clear All
                </button>
            </div>
        </div>

        <!-- Profile Components Test -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Profile Display -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">Profile Display</h3>
                <div class="space-y-2">
                    <p>Name: <span id="profile-name">Loading...</span></p>
                    <p>Email: <span id="profile-email">Loading...</span></p>
                </div>
            </div>

            <!-- Stats Display -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">Stats</h3>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div>Orders: <span id="total-orders">0</span></div>
                    <div>Spent: <span id="total-spent">₹0</span></div>
                    <div>Addresses: <span id="saved-addresses">0</span></div>
                    <div>Since: <span id="member-since">2024</span></div>
                </div>
            </div>

            <!-- Addresses Test -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">Addresses</h3>
                <div id="addresses-list" class="text-sm">Loading...</div>
            </div>

            <!-- Favorites Test -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">Favorites</h3>
                <div id="favorites-list" class="text-sm">Loading...</div>
            </div>
        </div>

        <!-- Link to Real Profile -->
        <div class="text-center mt-8">
            <a href="frontend/profile.html" class="bg-green-600 px-6 py-3 rounded-lg hover:bg-green-700 inline-block">
                🚀 Go to Real Profile Page
            </a>
        </div>
    </div>

    <script src="frontend/js/cart-sync.js"></script>
    <script>
        // Test data variables
        let userProfile = null;
        let orders = [];
        let addresses = [];
        let favorites = [];
        let testResults = [];

        // Copy the exact functions from profile.html for testing
        function updateStats() {
            try {
                const orderCount = orders ? orders.length : 0;
                const spentAmount = orders ? orders.reduce((sum, order) => sum + (order.total || 0), 0) : 0;
                const addressCount = addresses ? addresses.length : 0;
                
                let joinYear = new Date().getFullYear();
                if (userProfile && userProfile.joinDate) {
                    const joinDate = new Date(userProfile.joinDate);
                    if (!isNaN(joinDate.getTime())) {
                        joinYear = joinDate.getFullYear();
                    }
                }

                document.getElementById('total-orders').textContent = orderCount;
                document.getElementById('total-spent').textContent = '₹' + spentAmount.toLocaleString();
                document.getElementById('saved-addresses').textContent = addressCount;
                document.getElementById('member-since').textContent = joinYear;
                
                return true;
            } catch (error) {
                console.error('updateStats error:', error);
                return false;
            }
        }

        function renderAddresses() {
            try {
                const addressesList = document.getElementById('addresses-list');

                if (!addresses || addresses.length === 0) {
                    addressesList.innerHTML = `<div class="text-gray-400">No addresses</div>`;
                    return true;
                }

                const validAddresses = addresses.filter(address => address && address.name);
                addressesList.innerHTML = validAddresses.map((address, index) => `
                    <div class="border border-gray-600 p-2 rounded mb-2">
                        <div class="font-semibold">${address.name || 'Unknown'}</div>
                        <div class="text-xs text-gray-400">${address.street || 'No address'}</div>
                    </div>
                `).join('') || '<div class="text-gray-400">No valid addresses</div>';
                
                return true;
            } catch (error) {
                console.error('renderAddresses error:', error);
                document.getElementById('addresses-list').innerHTML = '<div class="text-red-400">Error loading addresses</div>';
                return false;
            }
        }

        function renderFavorites() {
            try {
                const favoritesList = document.getElementById('favorites-list');

                if (!favorites || favorites.length === 0) {
                    favoritesList.innerHTML = `<div class="text-gray-400">No favorites</div>`;
                    return true;
                }

                const validFavorites = favorites.filter(item => item && item.name);
                favoritesList.innerHTML = validFavorites.map(item => `
                    <div class="border border-gray-600 p-2 rounded mb-2">
                        <div class="font-semibold">${item.name || 'Unknown Item'}</div>
                        <div class="text-xs text-gray-400">₹${item.price || '0'}</div>
                    </div>
                `).join('') || '<div class="text-gray-400">No valid favorites</div>';
                
                return true;
            } catch (error) {
                console.error('renderFavorites error:', error);
                document.getElementById('favorites-list').innerHTML = '<div class="text-red-400">Error loading favorites</div>';
                return false;
            }
        }

        function fallbackToLocalStorage() {
            try {
                const username = localStorage.getItem('username') || 'Test User';
                const userEmail = localStorage.getItem('userEmail') || 'test@vitalbites.com';
                
                document.getElementById('profile-name').textContent = username;
                document.getElementById('profile-email').textContent = userEmail;
                
                userProfile = {
                    name: username,
                    email: userEmail,
                    joinDate: new Date().toISOString()
                };
                
                return true;
            } catch (error) {
                console.error('fallbackToLocalStorage error:', error);
                return false;
            }
        }

        function runTest(testName, testFunction) {
            try {
                const result = testFunction();
                const status = result ? '✅' : '❌';
                testResults.push(`${status} ${testName}: ${result ? 'PASSED' : 'FAILED'}`);
                return result;
            } catch (error) {
                testResults.push(`❌ ${testName}: ERROR - ${error.message}`);
                return false;
            }
        }

        function updateTestResults() {
            document.getElementById('test-results').innerHTML = testResults.map(result => 
                `<div class="${result.includes('✅') ? 'text-green-400' : 'text-red-400'}">${result}</div>`
            ).join('');
        }

        // Test scenarios
        document.getElementById('testNull').addEventListener('click', function() {
            testResults = [];
            userProfile = null;
            orders = null;
            addresses = null;
            favorites = null;

            runTest('Null Data - updateStats', updateStats);
            runTest('Null Data - renderAddresses', renderAddresses);
            runTest('Null Data - renderFavorites', renderFavorites);
            runTest('Null Data - fallbackToLocalStorage', fallbackToLocalStorage);
            
            updateTestResults();
        });

        document.getElementById('testEmpty').addEventListener('click', function() {
            testResults = [];
            userProfile = {};
            orders = [];
            addresses = [];
            favorites = [];

            runTest('Empty Arrays - updateStats', updateStats);
            runTest('Empty Arrays - renderAddresses', renderAddresses);
            runTest('Empty Arrays - renderFavorites', renderFavorites);
            runTest('Empty Arrays - fallbackToLocalStorage', fallbackToLocalStorage);
            
            updateTestResults();
        });

        document.getElementById('testMixed').addEventListener('click', function() {
            testResults = [];
            userProfile = { name: 'Test User', joinDate: '2023-01-01' };
            orders = [{ total: 500 }, null, { total: 300 }];
            addresses = [null, { name: 'Home', street: '123 Test St' }, {}];
            favorites = [{ name: 'Pizza', price: 200 }, null, { name: 'Burger' }];

            runTest('Mixed Data - updateStats', updateStats);
            runTest('Mixed Data - renderAddresses', renderAddresses);
            runTest('Mixed Data - renderFavorites', renderFavorites);
            runTest('Mixed Data - fallbackToLocalStorage', fallbackToLocalStorage);
            
            updateTestResults();
        });

        document.getElementById('clearAllTest').addEventListener('click', function() {
            testResults = ['🧹 Cleared all test data'];
            userProfile = null;
            orders = [];
            addresses = [];
            favorites = [];
            
            document.getElementById('profile-name').textContent = 'Loading...';
            document.getElementById('profile-email').textContent = 'Loading...';
            document.getElementById('addresses-list').innerHTML = 'Loading...';
            document.getElementById('favorites-list').innerHTML = 'Loading...';
            
            updateTestResults();
        });

        // Initial test
        document.addEventListener('DOMContentLoaded', function() {
            testResults = ['🚀 Profile Error Fix Test Initialized'];
            updateTestResults();
            
            // Run basic test
            setTimeout(() => {
                document.getElementById('testEmpty').click();
            }, 500);
        });
    </script>
</body>
</html>
